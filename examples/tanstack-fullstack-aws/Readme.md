# Limgen `@tanstack/start` Example

This folder shows a complete, minimal example using [limgen](https://github.com/limlabs/limgen) to create an infrastructure project deployed to AWS using Docker (through ECS Fargate).

You can either download this folder directly and use it, or follow the guide below to build it from scratch.

## Guide

To understand what's happening to help your app get deployed through limgen, use the following steps:

1. Create a new tanstack start project using these steps: https://tanstack.com/router/latest/docs/framework/react/start/getting-started
1. Inside your project folder, open a new terminal and run this command:

    ```bash
    npx limgen init --includeDb=false --includeStorage=false --networkType=public
    ```

    This will generate a few files inside your project:

      - `Dockerfile` - A Dockerfile customized to work with Tanstack.
        
        - **Note: there is an important difference from the original Tanstack Start example!** Only the `data` folder is writeable by the user running the Node process. We will make a small change to the example in step 3 to handle this.
  
      - `.dockerignore` - Adds common files that should not be copied into the image during `docker build`
      - `app.config.ts` - Updates the Vinxi config to add the required `server.preset` value
      - `infrastructure/` - This is where our infrastructure-as-code (IaC) is stored. IaC generated by limgen uses [Pulumi](https://www.pulumi.com/product/infrastructure-as-code/) and Typescript. 
      
1. Next, we're going to modify the project to ensure the `count.txt` is writeable from the Docker container. Open the `app/routes/index.ts` and update it to the following code:

    ```tsx
    // app/routes/index.tsx
    import * as fs from 'node:fs'
    import { createFileRoute, useRouter } from '@tanstack/react-router'
    import { createServerFn } from '@tanstack/start'
    import path from 'node:path'

    // Use the 'data' folder to store count.txt
    // This is the only actual change to the original example
    const filePath = path.join('data', 'count.txt')

    async function readCount() {
      return parseInt(
        await fs.promises.readFile(filePath, 'utf-8').catch(() => '0'),
      )
    }

    const getCount = createServerFn({
      method: 'GET',
    }).handler(() => {
      return readCount()
    })

    const updateCount = createServerFn({ method: 'POST' })
      .validator((d: number) => d)
      .handler(async ({ data }) => {
        const count = await readCount()
        await fs.promises.writeFile(filePath, `${count + data}`)
      })

    export const Route = createFileRoute('/')({
      component: Home,
      loader: async () => await getCount(),
    })

    function Home() {
      const router = useRouter()
      const state = Route.useLoaderData()

      return (
        <button
          type="button"
          onClick={() => {
            updateCount({ data: 1 }).then(() => {
              router.invalidate()
            })
          }}
        >
          Add 1 to {state}?
        </button>
      )
    }
    ```

1. Make sure you are [logged into the AWS CLI](https://docs.aws.amazon.com/signin/latest/userguide/command-line-sign-in.html).
1. Make sure you have installed [Pulumi](https://www.pulumi.com/):


      ```bash
      # A one-line command to install Pulumi in macOS / linux
      curl -fsSL https://get.pulumi.com | sh 
      ```


1. Change directories into the Pulumi project we created earlier, and run `pulumi up` to start your stack:

    ```bash
    # Replace <myapp> with your project name from Step 2
    cd infrastructure/projects/<myapp>/

    # Create your new stack
    pulumi up
    ```

    - If you're new to IaC, we recommend using [Pulumi Cloud](https://www.pulumi.com/product/pulumi-cloud/) to manage your state when prompted to login / signup. You can also store your state in AWS, Azure, or locally [with additional configuration.
](https://www.pulumi.com/docs/iac/concepts/state-and-backends/)
    
1. When prompted to create resources, choose "Y" (yes)
1. Wait for 8-10 minutes for the resources to be created for the first time.

    - When complete, you should see some output similar to the following:

    ```
    Outputs:
      cdnHostname: "https://d3a29q3lp0krrp.cloudfront.net"
      service    : "tanstack-fullstack-aws-dev-service"
      vpcId      : "vpc-079bbf3b69b8e2248"

    Resources:
        42 unchanged
    ```

1. Click on the link from `cdnHostname` output. Your site should open in the browser! Confirm that the counter increments as expected, and that it persists when you refresh the browser.


### Deploying Updates

Changing app code will trigger a new Docker image build, which will in turn deploy an updated version of your service to AWS.

To deploy an udpdate, edit your app code and follow the same process as deploying the stack for the first time:

```bash
# Replace <myapp> with your project name from Step 2
cd infrastructure/projects/<myapp>/

# Select and update your existing stack
pulumi up
```

### Caveats

This example does not have persistent storage. This means it will not work with more than one task instance. The count will also be reset across deployments.

To allow for persistent storage, consider using the `object-storage-s3` component by running `npx limgen add object-storage-s3`. This creates a private storage bucket in S3 your app can use to read/write files. Configuring this component and making the changes to your app to support the aws-sdk are currently outside the scope of this guide.

